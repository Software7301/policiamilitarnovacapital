<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notícias - Ouvidoria da Polícia Militar</title>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="shortcut icon" href="../assets/Logo_PMESP.png" type="image/x-icon">
</head>
<body>
    <header>
        <div class="logo">
            <h1>Ouvidoria PM NC</h1>
            <img class="logo-pmesp" src="../assets/Logo_PMESP.png" alt="Logo PMESP">
            <button id="menu-toggle" class="menu-toggle" aria-label="Abrir menu">
                <span>&#9776;</span>
            </button>
        </div>
        <nav>
            <div class="nav-menu">
                <ul>
                    <li><a href="index.html">Início</a></li>
                    <li><a href="denunciar.html">Denunciar</a></li>
                    <li><a href="noticias.html">Notícias</a></li>
                    <li><a href="index.html#contato">Contato</a></li>
                    <li><a href="../components/admin/admin.html" target="_blank">Painel</a></li>
                </ul>                   
            </div>
        </nav>
    </header>
    
    <section class="noticias-page">
        <div class="content">
            <div class="noticias-header">
                <h2>Notícias e Comunicados</h2>
                <p>Fique por dentro das últimas notícias e comunicados da Polícia Militar da Nova Capital.</p>
            </div>
            
            <div class="noticias-container">
                <div class="noticias-lista" id="noticiasLista">
                    <!-- Notícias serão carregadas dinamicamente aqui -->
                    <div class="loading-noticias">
                        <div class="spinner"></div>
                        <p>Carregando notícias...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Modal para notícia completa -->
    <div id="noticiaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitulo"></h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-meta">
                    <span id="modalData" class="modal-data"></span>
                </div>
                <div id="modalConteudo" class="modal-conteudo"></div>
                <div id="modalFotos" class="modal-fotos"></div>
            </div>
        </div>
    </div>

    <!-- Navegação inferior -->
    <footer class="bottom-nav">
        <div class="bottom-nav-content">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">🏠</span>
                <span class="nav-text">Início</span>
            </a>
            <a href="denunciar.html" class="nav-item">
                <span class="nav-icon">📝</span>
                <span class="nav-text">Denunciar</span>
            </a>
            <a href="noticias.html" class="nav-item active">
                <span class="nav-icon">📰</span>
                <span class="nav-text">Notícias</span>
            </a>
            <button class="nav-item" id="equipeBtn">
                <span class="nav-icon">👥</span>
                <span class="nav-text">Equipe</span>
            </button>
            <a href="../components/admin/admin.html" class="nav-item" target="_blank">
                <span class="nav-icon">⚙️</span>
                <span class="nav-text">Admin</span>
            </a>
        </div>
    </footer>

    <!-- Modal da Equipe -->
    <div id="equipeModal" class="modal">
        <div class="modal-content equipe-modal">
            <div class="modal-header">
                <h2>Nossa Equipe</h2>
                <span class="close" id="closeEquipeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="equipe-container">
                    <div class="equipe-grid">
                        <div class="membro-equipe">
                            <div class="avatar">
                                <span class="avatar-icon">👨‍💼</span>
                            </div>
                            <div class="membro-info">
                                <h3>Comandante Silva</h3>
                                <p>Comandante Geral</p>
                            </div>
                        </div>
                        <div class="membro-equipe">
                            <div class="avatar">
                                <span class="avatar-icon">👩‍💼</span>
                            </div>
                            <div class="membro-info">
                                <h3>Tenente Santos</h3>
                                <p>Ouvidora</p>
                            </div>
                        </div>
                        <div class="membro-equipe">
                            <div class="avatar">
                                <span class="avatar-icon">👨‍🔧</span>
                            </div>
                            <div class="membro-info">
                                <h3>Sargento Costa</h3>
                                <p>Coordenador Técnico</p>
                            </div>
                        </div>
                        <div class="membro-equipe">
                            <div class="avatar">
                                <span class="avatar-icon">👩‍💻</span>
                            </div>
                            <div class="membro-info">
                                <h3>Cabo Oliveira</h3>
                                <p>Suporte Técnico</p>
                            </div>
                        </div>
                        <div class="membro-equipe">
                            <div class="avatar">
                                <span class="avatar-icon">👨‍🚔</span>
                            </div>
                            <div class="membro-info">
                                <h3>Soldado Pereira</h3>
                                <p>Patrulheiro</p>
                            </div>
                        </div>
                        <div class="membro-equipe">
                            <div class="avatar">
                                <span class="avatar-icon">👩‍⚖️</span>
                            </div>
                            <div class="membro-info">
                                <h3>Delegada Lima</h3>
                                <p>Assessora Jurídica</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let noticiasData = []; // Armazenar dados das notícias
        
        // Carregar notícias do backend
        async function carregarNoticias() {
            const noticiasLista = document.getElementById('noticiasLista');
            
            try {
                const response = await fetch('https://policiamilitarnovacapital.onrender.com/api/noticias');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log('📰 Resposta da API de notícias:', responseData);
                
                // Verificar se a resposta tem a estrutura {noticias: [...]}
                let noticias = [];
                if (responseData.noticias) {
                    noticias = responseData.noticias;
                } else if (Array.isArray(responseData)) {
                    noticias = responseData;
                } else {
                    console.error('❌ Estrutura de resposta inesperada:', responseData);
                    throw new Error('Formato de resposta inválido');
                }
                
                console.log('📰 Notícias processadas:', noticias);
                
                if (noticias.length === 0) {
                    noticiasLista.innerHTML = `
                        <div class="sem-noticias">
                            <h3>Nenhuma notícia publicada</h3>
                            <p>Aguarde novas publicações da Polícia Militar.</p>
                        </div>
                    `;
                    return;
                }
                
                // Ordenar por data mais recente
                noticias.sort((a, b) => new Date(b.data_publicacao) - new Date(a.data_publicacao));
                
                // Armazenar dados para usar no modal
                noticiasData = noticias;
                
                noticiasLista.innerHTML = noticias.map((noticia, index) => {
                    const data = new Date(noticia.data_publicacao);
                    const dataFormatada = data.toLocaleDateString('pt-BR');
                    
                                         // Processar quebras de linha no conteúdo com melhor tratamento
                     let conteudoFormatado = '';
                     if (noticia.conteudo) {
                         console.log('Conteúdo original:', noticia.conteudo);
                         console.log('Tipo do conteúdo:', typeof noticia.conteudo);
                         
                         // Se o conteúdo tem quebras de linha naturais, usar elas
                         if (noticia.conteudo.includes('\n')) {
                             const paragrafos = noticia.conteudo.split('\n').filter(linha => linha.trim() !== '');
                             console.log('Parágrafos processados:', paragrafos);
                             
                             conteudoFormatado = paragrafos.map(paragrafo => {
                                 const textoEscapado = paragrafo
                                     .replace(/&/g, '&amp;')
                                     .replace(/</g, '&lt;')
                                     .replace(/>/g, '&gt;')
                                     .replace(/"/g, '&quot;')
                                     .replace(/'/g, '&#39;');
                                 return `<p>${textoEscapado}</p>`;
                             }).join('');
                         } else {
                             // Se não tem quebras de linha, quebrar automaticamente a cada 80 caracteres
                             const texto = noticia.conteudo;
                             const maxChars = 80;
                             const palavras = texto.split(' ');
                             let linhas = [];
                             let linhaAtual = '';
                             
                             for (let palavra of palavras) {
                                 if ((linhaAtual + palavra).length > maxChars) {
                                     if (linhaAtual) {
                                         linhas.push(linhaAtual.trim());
                                         linhaAtual = palavra + ' ';
                                     } else {
                                         // Palavra muito longa, quebrar no meio
                                         linhas.push(palavra.substring(0, maxChars));
                                         linhaAtual = palavra.substring(maxChars) + ' ';
                                     }
                                 } else {
                                     linhaAtual += palavra + ' ';
                                 }
                             }
                             
                             if (linhaAtual.trim()) {
                                 linhas.push(linhaAtual.trim());
                             }
                             
                             console.log('Linhas processadas:', linhas);
                             
                             conteudoFormatado = linhas.map(linha => {
                                 const textoEscapado = linha
                                     .replace(/&/g, '&amp;')
                                     .replace(/</g, '&lt;')
                                     .replace(/>/g, '&gt;')
                                     .replace(/"/g, '&quot;')
                                     .replace(/'/g, '&#39;');
                                 return `<p>${textoEscapado}</p>`;
                             }).join('');
                         }
                         
                         console.log('Conteúdo formatado:', conteudoFormatado);
                     } else {
                         conteudoFormatado = '<p>Conteúdo não disponível</p>';
                     }
                    
                    // Processar fotos se existirem
                    let fotosHtml = '';
                    if (noticia.fotos) {
                        try {
                            let fotos = [];
                            
                            if (typeof noticia.fotos === 'string') {
                                // Fotos salvas como string separada por vírgulas
                                fotos = noticia.fotos.split(',').filter(foto => foto.trim() !== '');
                            } else if (Array.isArray(noticia.fotos)) {
                                // Fotos já como array
                                fotos = noticia.fotos;
                            } else {
                                // Tentar parsear como JSON
                                fotos = JSON.parse(noticia.fotos);
                            }
                            
                            if (fotos.length > 0) {
                                fotosHtml = `
                                    <div class="noticia-fotos">
                                        <h4>📷 Fotos da Notícia</h4>
                                        <div class="noticia-fotos-grid">
                                            ${fotos.map(foto => {
                                                // Limpar a URL da foto
                                                const fotoUrl = foto.trim();
                                                if (fotoUrl && (fotoUrl.startsWith('http') || fotoUrl.startsWith('data:'))) {
                                                    return `
                                                        <div class="noticia-foto-item">
                                                            <img src="${fotoUrl}" alt="Foto da notícia" class="noticia-foto-img">
                                                        </div>
                                                    `;
                                                } else {
                                                    return `
                                                        <div class="noticia-foto-item">
                                                            <div class="noticia-foto-info">
                                                                <span>📷 Foto</span>
                                                            </div>
                                                        </div>
                                                    `;
                                                }
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        } catch (e) {
                            console.log('Erro ao processar fotos:', e);
                        }
                    }
                    
                    return `
                        <article class="noticia-card">
                            <h3>${noticia.titulo || 'Sem título'}</h3>
                            <span class="data">${dataFormatada}</span>
                            <div class="noticia-conteudo">${conteudoFormatado}</div>
                            ${fotosHtml}
                            <a href="#" class="ler-mais" onclick="abrirNoticia(${index})">Ler mais</a>
                        </article>
                    `;
                }).join('');
                
            } catch (error) {
                console.log('Erro ao carregar notícias:', error);
                noticiasLista.innerHTML = `
                    <div class="sem-noticias">
                        <h3>Erro ao carregar notícias</h3>
                        <p>Não foi possível conectar ao servidor. Tente novamente mais tarde.</p>
                    </div>
                `;
            }
        }
        
        // Abrir modal com notícia completa
        function abrirNoticia(index) {
            const noticia = noticiasData[index];
            const modal = document.getElementById('noticiaModal');
            const modalTitulo = document.getElementById('modalTitulo');
            const modalData = document.getElementById('modalData');
            const modalConteudo = document.getElementById('modalConteudo');
            const modalFotos = document.getElementById('modalFotos');
            
            // Formatar data
            const data = new Date(noticia.data_publicacao);
            const dataFormatada = data.toLocaleDateString('pt-BR');
            
                         // Processar quebras de linha no conteúdo com melhor tratamento
             let conteudoFormatado = '';
             if (noticia.conteudo) {
                 // Se o conteúdo tem quebras de linha naturais, usar elas
                 if (noticia.conteudo.includes('\n')) {
                     const paragrafos = noticia.conteudo.split('\n').filter(linha => linha.trim() !== '');
                     
                     // Criar parágrafos HTML
                     conteudoFormatado = paragrafos.map(paragrafo => {
                         // Escapar HTML para evitar injeção
                         const textoEscapado = paragrafo
                             .replace(/&/g, '&amp;')
                             .replace(/</g, '&lt;')
                             .replace(/>/g, '&gt;')
                             .replace(/"/g, '&quot;')
                             .replace(/'/g, '&#39;');
                         
                         return `<p>${textoEscapado}</p>`;
                     }).join('');
                 } else {
                     // Se não tem quebras de linha, quebrar automaticamente a cada 80 caracteres
                     const texto = noticia.conteudo;
                     const maxChars = 80;
                     const palavras = texto.split(' ');
                     let linhas = [];
                     let linhaAtual = '';
                     
                     for (let palavra of palavras) {
                         if ((linhaAtual + palavra).length > maxChars) {
                             if (linhaAtual) {
                                 linhas.push(linhaAtual.trim());
                                 linhaAtual = palavra + ' ';
                             } else {
                                 // Palavra muito longa, quebrar no meio
                                 linhas.push(palavra.substring(0, maxChars));
                                 linhaAtual = palavra.substring(maxChars) + ' ';
                             }
                         } else {
                             linhaAtual += palavra + ' ';
                         }
                     }
                     
                     if (linhaAtual.trim()) {
                         linhas.push(linhaAtual.trim());
                     }
                     
                     // Criar parágrafos HTML
                     conteudoFormatado = linhas.map(linha => {
                         const textoEscapado = linha
                             .replace(/&/g, '&amp;')
                             .replace(/</g, '&lt;')
                             .replace(/>/g, '&gt;')
                             .replace(/"/g, '&quot;')
                             .replace(/'/g, '&#39;');
                         return `<p>${textoEscapado}</p>`;
                     }).join('');
                 }
                 
                 console.log('Conteúdo processado:', conteudoFormatado);
             } else {
                 conteudoFormatado = '<p>Conteúdo não disponível</p>';
             }
            
            // Preencher modal
            modalTitulo.textContent = noticia.titulo || 'Sem título';
            modalData.textContent = dataFormatada;
            modalConteudo.innerHTML = conteudoFormatado;
            
            // Processar fotos se existirem
            modalFotos.innerHTML = '';
            if (noticia.fotos && noticia.fotos.length > 0) {
                try {
                    const fotos = Array.isArray(noticia.fotos) ? noticia.fotos : JSON.parse(noticia.fotos);
                    if (fotos.length > 0) {
                        const fotosHtml = `
                            <div class="modal-fotos-section">
                                <h4>📷 Fotos da Notícia</h4>
                                <div class="modal-fotos-grid">
                                    ${fotos.map(foto => {
                                        let imgSrc = '';
                                        let imgAlt = '';
                                        
                                        if (typeof foto === 'string') {
                                            imgSrc = foto;
                                            imgAlt = 'Foto da notícia';
                                        } else if (foto.dataUrl) {
                                            imgSrc = foto.dataUrl;
                                            imgAlt = foto.name || 'Foto da notícia';
                                        } else if (foto.url) {
                                            imgSrc = foto.url;
                                            imgAlt = foto.name || 'Foto da notícia';
                                        }
                                        
                                        if (imgSrc) {
                                            return `
                                                <div class="modal-foto-item">
                                                    <img src="${imgSrc}" alt="${imgAlt}" class="modal-foto-img">
                                                </div>
                                            `;
                                        } else {
                                            return `
                                                <div class="modal-foto-item">
                                                    <div class="modal-foto-info">
                                                        <span>📷 ${foto.name || 'Foto'}</span>
                                                        <small>${(foto.size / 1024).toFixed(1)} KB</small>
                                                    </div>
                                                </div>
                                            `;
                                        }
                                    }).join('')}
                                </div>
                            </div>
                        `;
                        modalFotos.innerHTML = fotosHtml;
                    }
                } catch (e) {
                    console.log('Erro ao processar fotos:', e);
                }
            }
            
            // Mostrar modal
            modal.style.display = 'block';
        }
        
        // Fechar modal
        function fecharModal() {
            const modal = document.getElementById('noticiaModal');
            modal.style.display = 'none';
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            carregarNoticias();
            
            // Fechar modal ao clicar no X
            document.querySelector('.close').addEventListener('click', fecharModal);
            
            // Fechar modal ao clicar fora dele
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('noticiaModal');
                if (event.target === modal) {
                    fecharModal();
                }
            });
            
            // Fechar modal com ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    fecharModal();
                }
            });

            // Funcionalidade do Modal da Equipe
            const equipeBtn = document.getElementById('equipeBtn');
            const equipeModal = document.getElementById('equipeModal');
            const closeEquipeModal = document.getElementById('closeEquipeModal');

            // Abrir modal da equipe
            if (equipeBtn) {
                equipeBtn.addEventListener('click', function() {
                    equipeModal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                    
                    // Adicionar efeito de fade in
                    equipeModal.style.opacity = '0';
                    setTimeout(() => {
                        equipeModal.style.opacity = '1';
                    }, 10);
                    
                    // Animar entrada dos membros da equipe
                    const membros = document.querySelectorAll('.membro-equipe');
                    membros.forEach((membro, index) => {
                        setTimeout(() => {
                            membro.style.opacity = '1';
                            membro.style.transform = 'translateY(0)';
                        }, index * 100);
                    });
                });
            }

            // Fechar modal da equipe
            if (closeEquipeModal) {
                closeEquipeModal.addEventListener('click', function() {
                    fecharModalEquipe();
                });
            }

            // Fechar modal clicando fora dele
            if (equipeModal) {
                equipeModal.addEventListener('click', function(event) {
                    if (event.target === equipeModal) {
                        fecharModalEquipe();
                    }
                });
            }

            // Fechar modal com ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && equipeModal.style.display === 'block') {
                    fecharModalEquipe();
                }
            });

            function fecharModalEquipe() {
                equipeModal.style.opacity = '0';
                setTimeout(() => {
                    equipeModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }, 300);
                
                // Resetar animações dos membros
                const membros = document.querySelectorAll('.membro-equipe');
                membros.forEach(membro => {
                    membro.style.opacity = '0';
                    membro.style.transform = 'translateY(30px)';
                });
            }

            // Adicionar efeitos de hover nos membros da equipe
            const membrosEquipe = document.querySelectorAll('.membro-equipe');
            membrosEquipe.forEach(membro => {
                membro.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px) scale(1.02)';
                });
                
                membro.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
                
                // Efeito de clique
                membro.addEventListener('click', function() {
                    this.style.transform = 'translateY(-2px) scale(0.98)';
                    setTimeout(() => {
                        this.style.transform = 'translateY(-5px) scale(1.02)';
                    }, 150);
                });
            });
        });
    </script>
</body>
</html> 