<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not√≠cias - Ouvidoria da Pol√≠cia Militar</title>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="shortcut icon" href="../assets/Logo_PMESP.png" type="image/x-icon">
</head>
<body>
    <header>
        <div class="logo">
            <h1>Ouvidoria PM NC</h1>
            <img class="logo-pmesp" src="../assets/Logo_PMESP.png" alt="Logo PMESP">
            <button id="menu-toggle" class="menu-toggle" aria-label="Abrir menu">
                <span>&#9776;</span>
            </button>
        </div>
        <nav>
            <div class="nav-menu">
                <ul>
                    <li><a href="index.html">In√≠cio</a></li>
                    <li><a href="denunciar.html">Denunciar</a></li>
                    <li><a href="noticias.html">Not√≠cias</a></li>
                    <li><a href="index.html#contato">Contato</a></li>
                    <li><a href="../components/admin/admin.html" target="_blank">Painel</a></li>
                </ul>                   
            </div>
        </nav>
    </header>
    
    <section class="noticias-page">
        <div class="content">
            <div class="noticias-header">
                <h2>Not√≠cias e Comunicados</h2>
                <p>Fique por dentro das √∫ltimas not√≠cias e comunicados da Pol√≠cia Militar da Nova Capital.</p>
            </div>
            
            <div class="noticias-container">
                <div class="noticias-lista" id="noticiasLista">
                    <!-- Not√≠cias ser√£o carregadas dinamicamente aqui -->
                    <div class="loading-noticias">
                        <div class="spinner"></div>
                        <p>Carregando not√≠cias...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Modal para not√≠cia completa -->
    <div id="noticiaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitulo"></h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-meta">
                    <span id="modalData" class="modal-data"></span>
                </div>
                <div id="modalConteudo" class="modal-conteudo"></div>
                <div id="modalFotos" class="modal-fotos"></div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Ouvidoria da Pol√≠cia Militar da Nova Capital. Todos os direitos reservados.</p>
    </footer>
    
    <script>
        let noticiasData = []; // Armazenar dados das not√≠cias
        
        // Carregar not√≠cias do backend
        async function carregarNoticias() {
            const noticiasLista = document.getElementById('noticiasLista');
            
            try {
                const response = await fetch('https://policiamilitarnovacapital.onrender.com/api/noticias');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const noticias = await response.json();
                
                if (noticias.length === 0) {
                    noticiasLista.innerHTML = `
                        <div class="sem-noticias">
                            <h3>Nenhuma not√≠cia publicada</h3>
                            <p>Aguarde novas publica√ß√µes da Pol√≠cia Militar.</p>
                        </div>
                    `;
                    return;
                }
                
                // Ordenar por data mais recente
                noticias.sort((a, b) => new Date(b.data_publicacao) - new Date(a.data_publicacao));
                
                // Armazenar dados para usar no modal
                noticiasData = noticias;
                
                noticiasLista.innerHTML = noticias.map((noticia, index) => {
                    const data = new Date(noticia.data_publicacao);
                    const dataFormatada = data.toLocaleDateString('pt-BR');
                    
                    // Processar quebras de linha no conte√∫do com melhor tratamento
                    let conteudoFormatado = '';
                    if (noticia.conteudo) {
                        console.log('Conte√∫do original:', noticia.conteudo);
                        console.log('Tipo do conte√∫do:', typeof noticia.conteudo);
                        
                        const paragrafos = noticia.conteudo.split('\n').filter(linha => linha.trim() !== '');
                        console.log('Par√°grafos processados:', paragrafos);
                        
                        conteudoFormatado = paragrafos.map(paragrafo => {
                            const textoEscapado = paragrafo
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&#39;');
                            return `<p>${textoEscapado}</p>`;
                        }).join('');
                        
                        console.log('Conte√∫do formatado:', conteudoFormatado);
                    } else {
                        conteudoFormatado = '<p>Conte√∫do n√£o dispon√≠vel</p>';
                    }
                    
                    // Processar fotos se existirem
                    let fotosHtml = '';
                    if (noticia.fotos) {
                        try {
                            let fotos = [];
                            
                            if (typeof noticia.fotos === 'string') {
                                // Fotos salvas como string separada por v√≠rgulas
                                fotos = noticia.fotos.split(',').filter(foto => foto.trim() !== '');
                            } else if (Array.isArray(noticia.fotos)) {
                                // Fotos j√° como array
                                fotos = noticia.fotos;
                            } else {
                                // Tentar parsear como JSON
                                fotos = JSON.parse(noticia.fotos);
                            }
                            
                            if (fotos.length > 0) {
                                fotosHtml = `
                                    <div class="noticia-fotos">
                                        <h4>üì∑ Fotos da Not√≠cia</h4>
                                        <div class="noticia-fotos-grid">
                                            ${fotos.map(foto => {
                                                // Limpar a URL da foto
                                                const fotoUrl = foto.trim();
                                                if (fotoUrl && (fotoUrl.startsWith('http') || fotoUrl.startsWith('data:'))) {
                                                    return `
                                                        <div class="noticia-foto-item">
                                                            <img src="${fotoUrl}" alt="Foto da not√≠cia" class="noticia-foto-img">
                                                        </div>
                                                    `;
                                                } else {
                                                    return `
                                                        <div class="noticia-foto-item">
                                                            <div class="noticia-foto-info">
                                                                <span>üì∑ Foto</span>
                                                            </div>
                                                        </div>
                                                    `;
                                                }
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        } catch (e) {
                            console.log('Erro ao processar fotos:', e);
                        }
                    }
                    
                    return `
                        <article class="noticia-card">
                            <h3>${noticia.titulo || 'Sem t√≠tulo'}</h3>
                            <span class="data">${dataFormatada}</span>
                            <div class="noticia-conteudo">${conteudoFormatado}</div>
                            ${fotosHtml}
                            <a href="#" class="ler-mais" onclick="abrirNoticia(${index})">Ler mais</a>
                        </article>
                    `;
                }).join('');
                
            } catch (error) {
                console.log('Erro ao carregar not√≠cias:', error);
                noticiasLista.innerHTML = `
                    <div class="sem-noticias">
                        <h3>Erro ao carregar not√≠cias</h3>
                        <p>N√£o foi poss√≠vel conectar ao servidor. Tente novamente mais tarde.</p>
                    </div>
                `;
            }
        }
        
        // Abrir modal com not√≠cia completa
        function abrirNoticia(index) {
            const noticia = noticiasData[index];
            const modal = document.getElementById('noticiaModal');
            const modalTitulo = document.getElementById('modalTitulo');
            const modalData = document.getElementById('modalData');
            const modalConteudo = document.getElementById('modalConteudo');
            const modalFotos = document.getElementById('modalFotos');
            
            // Formatar data
            const data = new Date(noticia.data_publicacao);
            const dataFormatada = data.toLocaleDateString('pt-BR');
            
            // Processar quebras de linha no conte√∫do com melhor tratamento
            let conteudoFormatado = '';
            if (noticia.conteudo) {
                // Dividir por quebras de linha e filtrar linhas vazias
                const paragrafos = noticia.conteudo.split('\n').filter(linha => linha.trim() !== '');
                
                // Criar par√°grafos HTML
                conteudoFormatado = paragrafos.map(paragrafo => {
                    // Escapar HTML para evitar inje√ß√£o
                    const textoEscapado = paragrafo
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                    
                    return `<p>${textoEscapado}</p>`;
                }).join('');
                
                console.log('Conte√∫do processado:', conteudoFormatado);
            } else {
                conteudoFormatado = '<p>Conte√∫do n√£o dispon√≠vel</p>';
            }
            
            // Preencher modal
            modalTitulo.textContent = noticia.titulo || 'Sem t√≠tulo';
            modalData.textContent = dataFormatada;
            modalConteudo.innerHTML = conteudoFormatado;
            
            // Processar fotos se existirem
            modalFotos.innerHTML = '';
            if (noticia.fotos && noticia.fotos.length > 0) {
                try {
                    const fotos = Array.isArray(noticia.fotos) ? noticia.fotos : JSON.parse(noticia.fotos);
                    if (fotos.length > 0) {
                        const fotosHtml = `
                            <div class="modal-fotos-section">
                                <h4>üì∑ Fotos da Not√≠cia</h4>
                                <div class="modal-fotos-grid">
                                    ${fotos.map(foto => {
                                        let imgSrc = '';
                                        let imgAlt = '';
                                        
                                        if (typeof foto === 'string') {
                                            imgSrc = foto;
                                            imgAlt = 'Foto da not√≠cia';
                                        } else if (foto.dataUrl) {
                                            imgSrc = foto.dataUrl;
                                            imgAlt = foto.name || 'Foto da not√≠cia';
                                        } else if (foto.url) {
                                            imgSrc = foto.url;
                                            imgAlt = foto.name || 'Foto da not√≠cia';
                                        }
                                        
                                        if (imgSrc) {
                                            return `
                                                <div class="modal-foto-item">
                                                    <img src="${imgSrc}" alt="${imgAlt}" class="modal-foto-img">
                                                </div>
                                            `;
                                        } else {
                                            return `
                                                <div class="modal-foto-item">
                                                    <div class="modal-foto-info">
                                                        <span>üì∑ ${foto.name || 'Foto'}</span>
                                                        <small>${(foto.size / 1024).toFixed(1)} KB</small>
                                                    </div>
                                                </div>
                                            `;
                                        }
                                    }).join('')}
                                </div>
                            </div>
                        `;
                        modalFotos.innerHTML = fotosHtml;
                    }
                } catch (e) {
                    console.log('Erro ao processar fotos:', e);
                }
            }
            
            // Mostrar modal
            modal.style.display = 'block';
        }
        
        // Fechar modal
        function fecharModal() {
            const modal = document.getElementById('noticiaModal');
            modal.style.display = 'none';
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            carregarNoticias();
            
            // Fechar modal ao clicar no X
            document.querySelector('.close').addEventListener('click', fecharModal);
            
            // Fechar modal ao clicar fora dele
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('noticiaModal');
                if (event.target === modal) {
                    fecharModal();
                }
            });
            
            // Fechar modal com ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    fecharModal();
                }
            });
        });
    </script>
</body>
</html> 